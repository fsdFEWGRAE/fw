<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GLOM AUTHORIZATION</title>

    <!-- ===== GLOM THEME ===== -->
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700;900&display=swap");

        body {
            margin: 0;
            background: radial-gradient(circle at top, #2b0000, #000000 70%);
            font-family: "Montserrat", sans-serif;
            color: white;
            overflow: hidden;
        }

        /* ===== Neon Red Glow ===== */
        .glow-red {
            text-shadow: 0 0 15px #ff0000, 0 0 30px #b30000;
        }

        /* ===== Layout ===== */
        #app {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* ===== Sidebar ===== */
        .sidebar {
            width: 230px;
            background: rgba(0, 0, 0, 0.8);
            border-right: 2px solid #700000;
            padding: 25px 15px;
            box-sizing: border-box;
        }

        .logo {
            font-size: 26px;
            font-weight: 900;
            letter-spacing: 3px;
            margin-bottom: 35px;
        }

        .logo span {
            color: #ff1a1a;
        }

        .nav-btn {
            width: 100%;
            padding: 12px 10px;
            margin-bottom: 10px;
            background: #1a0000;
            border: 1px solid #700000;
            color: #ff4d4d;
            cursor: pointer;
            text-align: left;
            border-radius: 6px;
            transition: 0.2s;
        }

        .nav-btn:hover, .nav-btn.active {
            background: #700000;
            color: white;
        }

        /* ===== Main Content ===== */
        .content {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* ===== Inputs ===== */
        input, select {
            background: black;
            border: 1px solid #700000;
            padding: 10px;
            color: white;
            border-radius: 6px;
            width: 100%;
            margin-bottom: 12px;
        }

        button.glom-btn {
            padding: 10px 20px;
            border: none;
            background: #ff0000;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
            font-weight: bold;
            box-shadow: 0 0 10px #b30000;
        }

        button.glom-btn:hover {
            background: #b30000;
        }

        /* ===== Tables ===== */
        table {
            width: 100%;
            border-collapse: collapse;
            background: #0d0000;
        }

        th, td {
            padding: 12px;
            border: 1px solid #330000;
        }

        th {
            background: #330000;
        }
    </style>
</head>
<body>

<div id="app">
    <!-- ===== SIDEBAR ===== -->
    <div class="sidebar">
        <div class="logo glow-red">G L O M<br><small>AUTHORIZATION</small></div>

        <button class="nav-btn active" onclick="openPage('dashboard')">Dashboard</button>
        <button class="nav-btn" onclick="openPage('security')">Security</button>
        <button class="nav-btn" onclick="openPage('products')">Products</button>
        <button class="nav-btn" onclick="openPage('keys')">Keys</button>
        <button class="nav-btn" onclick="openPage('sources')">Sources</button>
        <button class="nav-btn" onclick="openPage('loader')">Loader Updates</button>

        <hr style="border-color:#300" />

        <button class="nav-btn" onclick="logout()">Logout</button>
    </div>

    <!-- ===== MAIN CONTENT ===== -->
    <div class="content">

        <!-- DASHBOARD -->
        <div class="page active" id="dashboard">
            <h1 class="glow-red">Dashboard</h1>
            <p>Welcome to GLOM Authorization Panel.</p>
        </div>

        <!-- SECURITY -->
        <div class="page" id="security">
            <h1 class="glow-red">Security</h1>
            <button class="glom-btn" onclick="enable2FA()">Enable 2FA</button>
            <button class="glom-btn" onclick="disable2FA()">Disable 2FA</button>

            <br><br>

            <button class="glom-btn" onclick="connectDiscord()">Connect Discord</button>
            <button class="glom-btn" onclick="disconnectDiscord()">Disconnect Discord</button>
        </div>

        <!-- PRODUCTS -->
        <div class="page" id="products">
            <h1 class="glow-red">Products</h1>

            <input id="newProductName" placeholder="Product Name" />
            <select id="newProductType">
                <option value="account">Username + Password</option>
                <option value="key">Key System</option>
            </select>

            <button class="glom-btn" onclick="createProduct()">Create Product</button>

            <h2>All Products</h2>
            <table id="productsTable"></table>
        </div>
        <!-- KEYS -->
        <div class="page" id="keys">
            <h1 class="glow-red">Keys</h1>

            <select id="keyProductSelect"></select>
            <input id="keyPanelUser" placeholder="Panel Username" />
            <input id="keyDays" placeholder="Days (leave empty for lifetime)" />

            <button class="glom-btn" onclick="createKey()">Create Key</button>

            <h2>All Keys</h2>
            <table id="keysTable"></table>
        </div>

        <!-- SOURCES / RESELLERS -->
        <div class="page" id="sources">
            <h1 class="glow-red">Users / Resellers</h1>

            <select id="newUserRole">
                <option value="OWNER">Owner Source</option>
                <option value="SOURCE">Source</option>
                <option value="PANEL">Panel</option>
            </select>

            <input id="newUserName" placeholder="Username" />
            <input id="newUserPass" placeholder="Password" />

            <button class="glom-btn" onclick="createUser()">Create User</button>

            <h2>Users</h2>
            <table id="usersTable"></table>
        </div>

        <!-- LOADER UPDATES -->
        <div class="page" id="loader">
            <h1 class="glow-red">Loader Updates</h1>

            <select id="updateProductSelect"></select>
            <input id="updateVersion" placeholder="Version (e.g. 1.0.3)" />
            <input id="updateGofile" placeholder="Gofile Direct Download URL" />
            <textarea id="updateNote" placeholder="Note (optional)" 
                style="width:100%;height:80px;background:black;border:1px solid #700000;color:white;border-radius:6px;margin-top:10px;"></textarea>

            <button class="glom-btn" onclick="pushUpdate()">Push Update</button>

            <h2>Latest Update</h2>
            <table id="loaderTable"></table>
        </div>

    </div> <!-- content -->
</div> <!-- app -->

<!-- ========== POPUPS / MODALS (Part 2 ends before full JS logic) ========== -->

<style>
    .modal-bg {
        position: fixed;
        top:0; left:0;
        width:100%; height:100%;
        background: rgba(0,0,0,0.75);
        display:none;
        justify-content:center;
        align-items:center;
        z-index:9;
    }
    .modal {
        background:#1a0000;
        border:1px solid #700000;
        padding:25px;
        width:400px;
        border-radius:8px;
        box-shadow:0 0 25px #700000;
    }
    .modal input, .modal select, .modal textarea {
        width:100%;
        margin-bottom:10px;
        padding:10px;
        border:1px solid #700000;
        background:black;
        color:white;
    }
    .modal-btn {
        display:flex;
        justify-content:flex-end;
        gap:10px;
    }
</style>

<!-- Example modal (will be dynamically reused) -->
<div class="modal-bg" id="popup">
    <div class="modal" id="popupContent">
        <!-- dynamic content goes here -->
    </div>
</div>
<!-- ========================================= -->
<!-- ============ MODAL TEMPLATES ============ -->
<!-- ========================================= -->

<!-- PRODUCT EDIT POPUP -->
<template id="modal-edit-product">
    <h2 class="glow-red">Edit Product</h2>

    <input id="editProdName" placeholder="Product Name" />
    <select id="editProdLoginMode">
        <option value="USER_PASS">Username + Password</option>
        <option value="KEY">Key System</option>
        <option value="BOTH">Both</option>
    </select>

    <input id="editProdApi" placeholder="API Token" />
    <textarea id="editProdNote" placeholder="Loader Note (optional)" 
        style="width:100%;height:60px;"></textarea>

    <div class="modal-btn">
        <button class="glom-btn" onclick="saveProductChanges()">Save</button>
        <button class="glom-btn" onclick="closePopup()">Close</button>
    </div>
</template>

<!-- ASSIGN SOURCE POPUP -->
<template id="modal-assign-source">
    <h2 class="glow-red">Assign Product to Source</h2>

    <input id="assignSourceName" placeholder="Source Username" />

    <div class="modal-btn">
        <button class="glom-btn" onclick="assignSource()">Assign</button>
        <button class="glom-btn" onclick="closePopup()">Close</button>
    </div>
</template>

<!-- ASSIGN PANEL POPUP -->
<template id="modal-assign-panel">
    <h2 class="glow-red">Assign Product to Panel</h2>

    <input id="assignPanelName" placeholder="Panel Username" />

    <div class="modal-btn">
        <button class="glom-btn" onclick="assignPanel()">Assign</button>
        <button class="glom-btn" onclick="closePopup()">Close</button>
    </div>
</template>

<!-- DELETE PRODUCT CONFIRM -->
<template id="modal-delete-product">
    <h2 class="glow-red">Delete Product</h2>
    <p>Are you sure you want to delete this product?</p>

    <div class="modal-btn">
        <button class="glom-btn" onclick="confirmDeleteProduct()">Delete</button>
        <button class="glom-btn" onclick="closePopup()">Cancel</button>
    </div>
</template>

<!-- DELETE KEY CONFIRM -->
<template id="modal-delete-key">
    <h2 class="glow-red">Delete Key</h2>
    <p>Are you sure you want to delete this key?</p>

    <div class="modal-btn">
        <button class="glom-btn" onclick="confirmDeleteKey()">Delete</button>
        <button class="glom-btn" onclick="closePopup()">Cancel</button>
    </div>
</template>

<!-- MASTER SECURITY (Disable 2FA / Discord) -->
<template id="modal-master-security">
    <h2 class="glow-red">Master Security Control</h2>

    <input id="masterTargetUser" placeholder="Username" />

    <div class="modal-btn" style="display:flex;flex-direction:column;gap:10px;">
        <button class="glom-btn" onclick="masterDisable2FA()">Disable 2FA</button>
        <button class="glom-btn" onclick="masterUnlinkDiscord()">Unlink Discord</button>
        <button class="glom-btn" onclick="closePopup()">Close</button>
    </div>
</template>

<!-- GENERIC CONFIRM POPUP -->
<template id="modal-confirm">
    <h2 class="glow-red">Confirm</h2>
    <p id="confirmMessage">Are you sure?</p>

    <div class="modal-btn">
        <button class="glom-btn" id="confirmYes">Yes</button>
        <button class="glom-btn" onclick="closePopup()">Cancel</button>
    </div>
</template>

<!-- POPUP JS CONTROL -->
<script>
    let currentPopupAction = null;

    function showPopup(templateId) {
        const template = document.getElementById(templateId);
        const popup = document.getElementById("popup");
        const content = document.getElementById("popupContent");

        content.innerHTML = template.innerHTML;
        popup.style.display = "flex";
    }

    function closePopup() {
        document.getElementById("popup").style.display = "none";
        currentPopupAction = null;
    }
</script>
<script>
// ================================
// GLOBAL CONFIG
// ================================
const API = "/glom/api";
let USER = null;

// ================================
// LOAD USER (from localStorage)
// ================================
function loadUser() {
    try {
        USER = JSON.parse(localStorage.getItem("GLOM_USER"));
    } catch {
        USER = null;
    }
}

// ================================
// SAVE USER
// ================================
function saveUser(u) {
    USER = u;
    localStorage.setItem("GLOM_USER", JSON.stringify(u));
}

// ================================
// LOGOUT
// ================================
function logout() {
    localStorage.removeItem("GLOM_USER");
    window.location.href = "/auth/login";
}

// ================================
// LOGIN
// ================================
async function login() {
    const user = document.getElementById("loginUser").value;
    const pass = document.getElementById("loginPass").value;

    const res = await fetch(`${API}/auth/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: user, password: pass })
    });

    const data = await res.json();

    if (!data.success) {
        alert(data.message || "Login failed");
        return;
    }

    saveUser(data.user);
    window.location.href = "/";
}

// ================================
// APPLY ROLE PERMISSIONS
// ================================
function applyRoleVisibility() {
    if (!USER) return;

    const lvl = USER.role.level;

    hideAllRoleBlocks();

    if (lvl >= 999) document.querySelectorAll(".role-master").forEach(e => e.style.display = "block");
    if (lvl >= 700) document.querySelectorAll(".role-owner").forEach(e => e.style.display = "block");
    if (lvl >= 400) document.querySelectorAll(".role-source").forEach(e => e.style.display = "block");
    
    document.querySelectorAll(".role-panel").forEach(e => e.style.display = "block");
}

function hideAllRoleBlocks() {
    document.querySelectorAll("[class*='role-']").forEach(e => e.style.display = "none");
}

// ================================
// LOAD PRODUCTS
// ================================
async function loadProducts() {
    const res = await fetch(`${API}/products/list`, {
        headers: { "Authorization": `Bearer ${USER.token}` }
    });
    const data = await res.json();

    if (!data.success) {
        alert("Failed to load products");
        return;
    }

    const box = document.getElementById("productsBox");
    box.innerHTML = "";

    data.products.forEach(p => {
        box.innerHTML += `
            <div class="product-card">
                <h3>${p.name}</h3>
                <p>Mode: ${p.loginMode}</p>
                <p>API: ${p.apiToken}</p>

                <button class="glom-btn role-owner role-master" onclick="openEditProduct('${p._id}')">Edit</button>
                <button class="glom-btn role-owner role-master" onclick="openDeleteProduct('${p._id}')">Delete</button>

                <button class="glom-btn role-owner" onclick="openAssignSource('${p._id}')">Assign Source</button>
                <button class="glom-btn role-owner" onclick="openAssignPanel('${p._id}')">Assign Panel</button>

                <button class="glom-btn" onclick="openKeys('${p._id}')">Keys</button>
                <button class="glom-btn" onclick="openLoaderUpdate('${p._id}')">Loader Update</button>
            </div>
        `;
    });
}

// ================================
// CREATE PRODUCT
// ================================
async function createProduct() {
    const name = document.getElementById("prodName").value;
    const mode = document.getElementById("prodMode").value;

    const res = await fetch(`${API}/products/create`, {
        method: "POST",
        headers: {
            "Authorization": `Bearer ${USER.token}`,
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ name, loginMode: mode })
    });

    const data = await res.json();

    if (!data.success) return alert(data.message);
    closePopup();
    loadProducts();
}

// ================================
// EDIT PRODUCT POPUP
// ================================
let CURRENT_PRODUCT = null;

async function openEditProduct(id) {
    CURRENT_PRODUCT = id;
    showPopup("modal-edit-product");

    const res = await fetch(`${API}/products/get/${id}`, {
        headers: { "Authorization": `Bearer ${USER.token}` }
    });
    const data = await res.json();

    if (!data.success) return alert("Failed to load");
    document.getElementById("editProdName").value = data.product.name;
    document.getElementById("editProdLoginMode").value = data.product.loginMode;
    document.getElementById("editProdApi").value = data.product.apiToken || "";
}

// ================================
// SAVE EDITED PRODUCT
// ================================
async function saveProductChanges() {
    const name = document.getElementById("editProdName").value;
    const mode = document.getElementById("editProdLoginMode").value;
    const api = document.getElementById("editProdApi").value;

    const res = await fetch(`${API}/products/update/${CURRENT_PRODUCT}`, {
        method: "POST",
        headers: {
            "Authorization": `Bearer ${USER.token}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ name, loginMode: mode, apiToken: api })
    });

    const data = await res.json();

    if (!data.success) return alert(data.message);
    closePopup();
    loadProducts();
}

// ================================
// DELETE PRODUCT
// ================================
function openDeleteProduct(id) {
    CURRENT_PRODUCT = id;
    showPopup("modal-delete-product");
}

async function confirmDeleteProduct() {
    const res = await fetch(`${API}/products/delete/${CURRENT_PRODUCT}`, {
        method: "POST",
        headers: { "Authorization": `Bearer ${USER.token}` }
    });

    const data = await res.json();
    if (!data.success) return alert(data.message);
    closePopup();
    loadProducts();
}

// ================================
// ASSIGN SOURCE
// ================================
function openAssignSource(id) {
    CURRENT_PRODUCT = id;
    showPopup("modal-assign-source");
}

async function assignSource() {
    const username = document.getElementById("assignSourceName").value;

    const res = await fetch(`${API}/products/assign-source/${CURRENT_PRODUCT}`, {
        method: "POST",
        headers: {
            "Authorization": `Bearer ${USER.token}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ username })
    });

    const data = await res.json();

    if (!data.success) return alert(data.message);

    closePopup();
    loadProducts();
}

// ================================
// ASSIGN PANEL
// ================================
function openAssignPanel(id) {
    CURRENT_PRODUCT = id;
    showPopup("modal-assign-panel");
}

async function assignPanel() {
    const username = document.getElementById("assignPanelName").value;

    const res = await fetch(`${API}/products/assign-panel/${CURRENT_PRODUCT}`, {
        method: "POST",
        headers: {
            "Authorization": `Bearer ${USER.token}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ username })
    });

    const data = await res.json();

    if (!data.success) return alert(data.message);

    closePopup();
    loadProducts();
}

// ================================
// KEYS PAGE
// ================================
async function openKeys(id) {
    CURRENT_PRODUCT = id;

    document.getElementById("mainPages").style.display = "none";
    document.getElementById("keysPage").style.display = "block";
    loadKeys(id);
}

async function loadKeys(id) {
    const res = await fetch(`${API}/keys/list/${id}`, {
        headers: { "Authorization": `Bearer ${USER.token}` }
    });

    const data = await res.json();
    if (!data.success) return alert(data.message);

    const box = document.getElementById("keysBox");
    box.innerHTML = "";

    data.keys.forEach(k => {
        box.innerHTML += `
        <div class="key-card">
            <h3>${k.key}</h3>
            <p>HWID: ${k.hwid || "None"}</p>
            <p>Duration: ${k.duration}</p>
            <p>Used: ${k.used}</p>

            <button class="glom-btn" onclick="openDeleteKey('${k._id}')">Delete</button>
        </div>`;
    });
}

// ================================
// DELETE KEY
// ================================
function openDeleteKey(id) {
    CURRENT_PRODUCT = id;
    showPopup("modal-delete-key");
}

async function confirmDeleteKey() {
    const res = await fetch(`${API}/keys/delete/${CURRENT_PRODUCT}`, {
        method: "POST",
        headers: { "Authorization": `Bearer ${USER.token}` }
    });

    const data = await res.json();
    if (!data.success) return alert(data.message);

    closePopup();
    loadKeys(CURRENT_PRODUCT);
}

// ================================
// MASTER SECURITY CONTROL
// ================================
function openMasterSecurity() {
    showPopup("modal-master-security");
}

async function masterDisable2FA() {
    const user = document.getElementById("masterTargetUser").value;

    const res = await fetch(`${API}/security/disable-2fa`, {
        method: "POST",
        headers: {
            "Authorization": `Bearer ${USER.token}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ username: user })
    });

    const data = await res.json();
    alert(data.message);
}

async function masterUnlinkDiscord() {
    const user = document.getElementById("masterTargetUser").value;

    const res = await fetch(`${API}/security/unlink-discord`, {
        method: "POST",
        headers: {
            "Authorization": `Bearer ${USER.token}`,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ username: user })
    });

    const data = await res.json();
    alert(data.message);
}

// ================================
// INITIALIZE PAGE
// ================================
window.onload = () => {
    loadUser();

    if (!USER && !window.location.href.includes("login"))
        return window.location.href = "/auth/login";

    if (USER) {
        applyRoleVisibility();
        loadProducts();
    }
};
</script>
